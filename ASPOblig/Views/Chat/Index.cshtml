@{
    ViewBag.Title = "Dette er en chat";
}

<div id="channels">
    <div id="addChannel" class="tab">></div>
    <input type="text" id="textbox-channel" />
</div>
<div id="userlists"></div>
<div id="menu">
    <p>Innstillinger</p>
    <p id="logout">Logg ut</p>
</div>
<div id="userinfo">Du er <b>...</b></div>
<div id="chats"></div>
<div id="entrywrap">
    <input type="text" id="entry" />
</div>
<div id="pms"></div>
<div id="contacts"><b>13</b> kontakter online</div>

<script type="text/javascript">
    var selectedChannel;
    var currentNick;

    $(document).ready(function () {
        window.onbeforeunload = function () { 
            $.get("Chat/Logout"); 
        }

        $(window).keyup(function(event) {
            if (event.which == 13) {
                $("#entry").focus();
            }
        });

        $("#addChannel").click(function () {
            $(this).hide();
            $("#textbox-channel").show();
            $("#textbox-channel").focus();
        });

        $("#logout").click(function () {
            $.get("Chat/Logout", function () {
                location = "";
            });
        });

        $("#userinfo").click(function () {
            $("#menu").toggle();
            if ($("#menu").is(":visible")) {
                $("#userinfo").addClass("selected");
            }
            else {
                $("#userinfo").removeClass("selected");
            }
        });

        $("#textbox-channel").keypress(function (event) {
            if (event.which == 13) {
                if ($(this).val() != "") {
                    joinChannel($(this).val());
                }
                $(this).val("");
                $(this).hide();
                $("#addChannel").show();
            }
        });

        $("#textbox-channel").focusout(function () {
            $(this).hide();
            $("#addChannel").show();
        });

        $("#entry").keypress(function (event) {
            if (event.which == 13) {
                if (selectedChannel != null) {
                    var message = $("#entry").val();
                    if (message != "") {
                        $.get("Chat/SendMessage", { message: message, destination: selectedChannel });
                        write(message, selectedChannel, currentNick);
                    }
                }
                $("#entry").val("");
            }
        });

        $.get("Chat/GetUserData", function (result) {
            currentNick = result;
            $("#userinfo").html("Du er <b>" + currentNick + "</b>");
        });

        $.get("Chat/Join", function () {
            joinChannel("Lobby");
            setTimeout(refreshMessages, 1000);
        });
    });

    function refreshUsers(channel) {
        $.get("Chat/GetUsers", { channel: channel }, function (result) {
            var userlist = "#users-" + channel;
            $(userlist).html("");
            for (n in result) {
                $(userlist).append('<p>' + result[n].nick + '</p>');
            }
            $(userlist + "-container").scrollbarPaper();            

            if (channel == selectedChannel) {
                document.title = selectedChannel + " [" + result.length + "]";
            }

            setTimeout(function () { refreshUsers(channel); }, 100);
        });
    }

    function joinChannel(channel) {
        $.get("Chat/JoinChannel", { channel: channel });
        
        $("#addChannel").before('<div id="chan-' + channel + '" class="tab">' + channel + '<div class="close">x</div></div>');
        $("#chats").append('<div id="' + channel + '-container" class="chat-container"><div id="' + channel + '" class="chat"></div></div>');
        $("#userlists").append('<div id="users-' + channel + '-container" class="users-container"><div id="users-' + channel + '" class="users"></div></div>');

        selectedChannel = channel;
        showChannel(channel);
        fixScroll("#" + channel + "-container");        
        fixScroll("#users-" + channel + "-container");
        refreshUsers(channel);

        $(".tab").click(function () {
            var channel = $(this).attr("id").split("-")[1];
            if (channel != null) {
                selectedChannel = channel;
                showChannel(selectedChannel);
            }
        });

        $(".tab .close").click(function() {
            leaveChannel($(this).parent().attr("id").split("-")[1]);
        });
    }

    function leaveChannel(channel) {
        $.get("Chat/LeaveChannel", { channel: channel });

        if (selectedChannel == channel) {
            selectedChannel = null;
        }

        $("#chan-" + channel).fadeOut("fast", function () {
            $("#chan-" + channel).remove();
            $("#" + channel + "-container").remove();
            $("#users-" + channel + "-container").remove();
        });
    }

    function refreshMessages() {
        $.get("Chat/GetMessages", function (result) {            
            for (n in result) {
                if (result[n].destination == currentNick) {
                    if ($("#chan-pm-" + result[n].sender).length < 1) {
                        $("#pms").append('<div id="chan-pm-' + result[n].sender + '" class="tab-pm">' + result[n].sender + '</div>');                        
                        $("#chats").append('<div id="pm-' + result[n].sender + '-container" class="chat-container"><div id="pm-' + result[n].sender + '" class="chat"></div></div>');
                        $("#chan-pm-" + result[n].sender).click(function() {
                            showChannelPm(result[n].sender);
                        });
                    }
                    write(result[n].message, "pm-" + result[n].sender, result[n].sender);
                }
                else {
                    write(result[n].message, result[n].destination, result[n].sender);
                }
            }

            setTimeout(refreshMessages, 100);
        });
    }

    function write(message, channel, nick) {
        var date = new Date();
        var time = pad(date.getHours()) + ":" + pad(date.getMinutes());

        $("#" + channel).append('<p class="message"><span class="timestamp">[' + time + ']</span> <b>' + nick + '</b> ' + message);
        $(".message").fadeIn("fast");
        $("#" + channel + "-container").scrollTop($("#" + channel + "-container").prop("scrollHeight"));
    }

    function showChannel(channel) {
        $(".tab, .tab-pm").removeClass("selected");
        $("#chan-" + channel).addClass("selected");
        $(".chat-container").hide();
        $("#" + channel + "-container").show();
        $("#" + channel + "-container").scrollbarPaper();
        $(".users-container").hide();
        $("#users-" + channel + "-container").show();
    }

    function showChannelPm(sender) {
        $(".tab-pm, .tab").removeClass("selected");
        $("#chan-pm-" + sender).addClass("selected");
        $(".chat-container").hide();
        $("#pm-" + sender + "-container").show();
        $("#pm-" + sender + "-container").scrollbarPaper();
    }

    function fixScroll(elem) {
        $(elem).mousewheel(function(event, delta) {
            $(elem).scrollTop($(elem).scrollTop() - delta*100);
        });
    }

    function pad(n) {
        if (n < 10) {
            return "0" + n;
        }
        return n;
    }
</script>